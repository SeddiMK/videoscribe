name: Deploy to Server videoscribe.zvon.online

on:
  push:
    branches:
      - master # —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –ø—É—à –≤ master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ
      - name: Build project
        run: |
          npm ci
          npm run build
        env:
          NODE_ENV: production

      # 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # 5. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
      - name: Create .env file
        run: |
          cat > .env.production << EOF
          NODE_ENV=production
          ${{ secrets.ENV_VARS }}
          EOF

      # 6. –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.env*' \
            --exclude '*.log' \
            --exclude 'README.md' \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.SERVER_IP }}:/var/www/zvon/

          # –ö–æ–ø–∏—Ä—É–µ–º .env –æ—Ç–¥–µ–ª—å–Ω–æ
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            .env.production root@${{ secrets.SERVER_IP }}:/var/www/zvon/.env

      # 7. –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ docker-compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'ENDSSH'
            cd /var/www/zvon
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            docker-compose ps -q | xargs -r docker inspect \
              --format='{{.Name}} {{.Config.Image}}' > .backup_images
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker-compose down
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
            docker-compose up -d --build --remove-orphans
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
            if ! docker-compose ps | grep -q "Up"; then
              echo "‚ö†Ô∏è  Deployment failed! Rolling back..."
              docker-compose down
              # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–∫–∞—Ç–∞
              exit 1
            fi
            
            # –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ dangling –æ–±—Ä–∞–∑—ã
            docker image prune -f
            
            echo "‚úÖ Deployment successful!"
          ENDSSH

      # 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      - name: Health check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" https://videoscribe.zvon.online)
          if [ "$response" != "200" ]; then
            echo "‚ö†Ô∏è  Health check failed! Status: $response"
            exit 1
          fi
          echo "‚úÖ Application is healthy!"

      # 9. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Notify success
        if: success()
        run: |
          echo "üöÄ Deployment to zvon.online completed successfully!"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram/Slack

      # 10. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Deployment to zvon.online failed!"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
